---
title: "Final Project"
author: "Ethan Rosenbaum, Xinyu Zheng, and  Beryl Nana Ama Akuffo-Kwapong"
date: "4/13/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(tidyverse)
library(sf)
library(readr)
library(tidycensus)
library(tigris)
library(janitor)
library(patchwork)
library(tidymodels)
library(purrr)

library(rgdal)


library(randomForest)
library(ranger)
library(parsnip)
theme_set(theme_minimal())
```

```{r load and clean floodplain Data}
# Load Sea Level Rise Maps (2050s 500-year Floodplain)
unzip(
  zipfile = "data/Sea Level Rise Maps (2050s 500-year Floodplain)-20220418T210520Z-001.zip",
  exdir = "data/Sea Level Rise Maps (2050s 500-year Floodplain)"
)
floodplain500 <- st_read("data/Sea Level Rise Maps (2050s 500-year Floodplain)/geo_export_e0ab4151-ea79-43e0-b860-b256c9a861bf.shp") %>%
  st_transform(crs = 4326)

# Load Sea Level Rise Maps (2050s 100-year Floodplain)
unzip(
  zipfile = "data/Sea Level Rise Maps (2050s 100-year Floodplain).zip",
  exdir = "data/Sea Level Rise Maps (2050s 100-year Floodplain)"
)
floodplain100 <- st_read("data/Sea Level Rise Maps (2050s 100-year Floodplain)/geo_export_a34f512c-89ff-48cf-97c8-9bc470c59c2b.shp") %>%
  st_transform(crs = 4326)

```

```{r loan and clean 2020 census data}

# Load demographic data
credential <- Sys.getenv("census_api_key")

lookup_var <- load_variables(2020, "acs5")

demogdata <- get_acs(
  geography = "tract",
  year = 2020,
  variables = c(
    white = "B02001_002", #race
    black = "B02001_003",
    indian_alaska = "B02001_004",
    asian = "B02001_005",
    pacific = "B02001_006",
    hhincome = "B19013_001", # median household income
    poverty = "B17020_002", # poverty level
    no_schooling = "B15003_002", #education attainment
    elementary_school = "B15003_009",
    secondary_school = "B15003_012",
    high_school = "B15003_017",
    bachelor = "B15003_022",
    employed = "B23025_004", # employment status
    unemployed = "B23025_005",
    no_in_labor_force = "23025_007"
  ),
  state =  36,
  county = c(005, 047, 061, 081, 085),
  key = credentia
)

# Tidy demogdata and change it into sf object
demogdata_clean <- demogdata %>%
  select(-moe) %>%
  pivot_wider(
    names_from = variable,
    values_from = estimate
  )

geo <- geo %>%
  select(GEOID, geometry)

demogdata_sf <- left_join(
  x = demogdata_clean, 
  y = geo
) %>%
  st_as_sf() %>%
  st_transform(crs = 4326) %>%
  mutate(
    GEOID = as.numeric(GEOID), #Label county name
    county = case_when(
      GEOID < 36047000000 ~ "Bronx",
      GEOID < 36061000000 ~ "Kings",
      GEOID < 36081000000 ~ "New_York",
      GEOID < 36085000000 ~ "Queens",
      TRUE ~ "Richmood"
    )
  )

# label floodplain100 and floodplain500 with county name
geo_county <- geo %>%
  mutate(
    GEOID = as.numeric(GEOID),
    county = case_when(
      GEOID < 36047000000 ~ "Bronx",
      GEOID < 36061000000 ~ "Kings",
      GEOID < 36081000000 ~ "New_York",
      GEOID < 36085000000 ~ "Queens",
      TRUE ~ "Richmood"
    )
  )

sf_use_s2(FALSE)
floodplain_county <- function(county_name){
  
   x <- st_union(filter(geo_county, county == county_name)) %>%
    st_as_sf(crs = 4326)
  
   y1 <- st_filter(floodplain100, x)
   y2 <- st_filter(floodplain500, x)
   
   assign(paste("floodplain100_", county_name, sep = ""), y1, envir = .GlobalEnv)
   assign(paste("floodplain500_", county_name, sep = ""), y2, envir = .GlobalEnv)
}

map(.x = c("Bronx", "Kings", "New_York", "Queens", "Richmood"), .f = floodplain_county)

```

```{r Maps}
# test
boundary_Bronx %>%
  ggplot() +
  geom_sf()

# Plot NYC demographic data with floodplain100 and floodplain 500
NYC_demo_floodplain <- function(demo_var){
  
  demo_NYU <- demogdata_sf %>%
    rename("estimate" = demo_var)
    
  ggplot() + 
  geom_sf(
    data = demogdata_sf,
    mapping = aes(fill = estimate), 
    color = "white"
  ) +
  scale_fill_gradient(
    low = "#cfe8f3",
    high = "#062635",
    na.value = "grey50"
  ) +
  geom_sf(
    data = floodplain500,
    fill = "red",
    color = "red",
    alpha = 0.1
  ) +
  geom_sf(
    data = floodplain100,
    fill = "yellow",
    color = "yellow",
    alpha = 0.1
  )
 
  ggsave(str_glue("image/plot_", demo_var, ".png", seq = ""), width = 12, height = 8)
  
}

map(.x = names(demogdata_sf)[3:16], .f = NYC_demo_floodplain)


# Plot NYC demographic data by counties with floodplain100 and floodplain 500
county_demo_floodplain <- function(county_name, demo_var){
  
  demo_county <- demogdata_sf %>%
    filter(county == county_name) %>%
    rename("estimate" = demo_var)
  
  ggplot() + 
  geom_sf(
    data = demo_county,
    mapping = aes(fill = estimate), 
    color = "white"
  ) +
  scale_fill_gradient(
    low = "#cfe8f3",
    high = "#062635",
    na.value = "white"
  ) +
  geom_sf(
    data = get(paste("floodplain500", county_name, sep = "_")),
    fill = "red",
    color = "red",
    alpha = 0.1
  ) +
  geom_sf(
    data = get(paste("floodplain100", county_name, sep = "_")),
    fill = "yellow",
    color = "yellow",
    alpha = 0.1
  )
  
  ggsave(str_glue("image/plot", county_name, demo_var, ".png", sep = "_"), width = 12, height = 8)
  
}

map2(
  .x = rep(c("Bronx", "Kings", "New_York", "Queens", "Richmood"), each = 14),
  .y = rep(names(demogdata_sf)[3:16], times = 5),
  .f = county_demo_floodplain
)

```

```{r Setting Up Models}
# joins floodplain with census tract map and codes tracts by whether they are in floodplain
floodtracts <- st_join(geo,floodplain500, join = st_intersects, left = FALSE)
demogdataflood <- demogdata_clean %>%
  mutate(flood = ifelse(GEOID %in% floodtracts$GEOID,1, 0))
# plot unified data showing census tracts contained within floodplain
ggplot() + 
  geom_sf(
    data= floodtracts 
  )
# add county name to data indicaing which tracts are within floodplain 
demogdatafloodboro <- demogdataflood %>%
    mutate(
    GEOID = as.numeric(GEOID), #Label county name
    county = case_when(
      GEOID < 36047000000 ~ "Bronx",
      GEOID < 36061000000 ~ "Kings",
      GEOID < 36081000000 ~ "New_York",
      GEOID < 36085000000 ~ "Queens",
      TRUE ~ "Richmond"))



smalldemogdataflood <- subset(demogdatafloodboro, select = -c(GEOID, NAME, county))
nadrop <- na.omit(smalldemogdataflood)
nadrop$flood <- factor(nadrop$flood)


# splits data into training and testing groups
split <- initial_split(nadrop, prop = 0.7, strata = "flood")
floodtracts_train <- training (split)
floodtracts_test <- testing (split)
# creates a recipe for the models using all variables as predictors 
floodtracts_rec <- 
  recipe(flood ~ ., data = floodtracts_train) %>%
  # center and scale all predictors
  step_center(all_predictors()) %>%
  step_scale(all_predictors()) %>%
  # drop near zero variance for all predictors
  step_nzv(all_predictors())
# sets up resampling using 10-fold cross validation
folds <- vfold_cv(data = floodtracts_train, v = 10, repeats = 1)
```

```{r CART Model}
# creates cart model
cart_mod <-
  decision_tree() %>%
  set_engine(engine = "rpart") %>%
  set_mode(mode = "classification")
# creates cart workflow
cart_wf <- workflow() %>%
  add_recipe(floodtracts_rec) %>%
  add_model(cart_mod)
# fits training data to workflow
cart_fit <- cart_wf %>%
  fit(data = floodtracts_train)
# plots decision tree
rpart.plot::rpart.plot(x = cart_fit$fit$fit$fit)
# applies model to testing data
predictions <- bind_cols(
  floodtracts_test,
  predict(object = cart_fit, new_data = floodtracts_test),
  predict(object = cart_fit, new_data = floodtracts_test, type = "prob")
)
# shows confusion matrix derived from model application 
conf_mat(data = predictions,
         truth = flood,
         estimate = .pred_class)
# displays accuracy of cart model
accuracy(data = predictions,
         truth = flood,
         estimate = .pred_class)
# displays precision of cart model
precision(data = predictions,
          truth = flood,
          estimate = .pred_class)
```

```{r Logistic Regression Model}
# run an initial logistic regression to get data for variable importance
floodlogit <- glm(flood ~., data = floodtracts_train, family = "binomial")
# displays importance of 10 most important variables
importances <- varImp(floodlogit)
importances %>%
  arrange(desc(Overall)) %>%
  top_n(10)
# sets up logistic regression model 
logistic_mod <- logistic_reg() %>%
  set_engine("glm")
# creates LR model workflow 
logistic_wf <- workflow() %>%
  add_model(logistic_mod) %>%
  add_recipe(floodtracts_rec)
# fits training data to logistic model 
logistic_fit <- logistic_wf %>%
  fit(data = floodtracts_train)
# show most important variables (according to decision tree model) by borough
demogdatafloodboro %>%
  group_by(county, flood) %>%
  summarize_at(vars("employed", "poverty", "high_school", "white", "bachelor"), mean)
# applies model to testing data 
predictionslog <- bind_cols(
  floodtracts_test,
  predict(object = logistic_fit, new_data = floodtracts_test),
  predict(object = logistic_fit, new_data = floodtracts_test, type = "prob")
)
# displays confusion matrix generated by logistic regression model 
conf_mat(data = predictionslog,
         truth = flood,
         estimate = .pred_class)
# displays accuracy of logistic regression model 
accuracy(data = predictionslog,
         truth = flood,
         estimate = .pred_class)
# displays precision of logistic regression model 
precision(data = predictionslog,
          truth = flood,
          estimate = .pred_class)
```

```{r KNN Model}
# sets up K-nearest neighbors model
knn_mod <-
  nearest_neighbor(neighbors = 5) %>%
  set_engine(engine = "kknn") %>%
  set_mode(mode = "classification")
# creates a knn workflow
knn_wf <-
  workflow() %>%
  add_recipe(floodtracts_rec) %>%
  add_model(knn_mod)
# fits the knn model on the training data
knn_fit <- knn_wf %>%
  fit(data = floodtracts_train)
# applies knn model to training data
predictionsknn <- bind_cols(
  floodtracts_test,
  predict(object = knn_fit, new_data = floodtracts_test)
)
# displays confusion matrix generated by knn model
conf_mat(data = predictionsknn,
         truth = flood,
         estimate = .pred_class)
# displays accuracy of knn model
accuracy(data = predictionsknn,
         truth = flood,
         estimate = .pred_class)
# displays precision of knn model
precision(data = predictionsknn,
          truth = flood,
          estimate = .pred_class)
```


## Test Other Data
### Load and clean data for modeling

```{r load and clean 2010 geographic data}
# NOTE: As Sandy happened in 2012, we use 2010 geographic data instead of 2020 one.
geo2010 <- tracts(
  state = 36,
  cb = TRUE,
  year = 2010
) %>%
  st_transform(crs = 4326)

geo2010 <- geo2010 %>% 
  select(-STATE, -NAME, -LSAD, -CENSUSAREA, -COUNTYFP, -STATEFP) %>% 
  clean_names() %>%
  mutate(geoid = substr(geo_id, 10, 20)) %>% 
  select(-geo_id)

```

```{r load, clean, and join Sandy data}

# Flooding damage
Sandy_damage <- read_csv("data/Sandy_Damage_Estimates_by_Block_Group.csv") %>% 
  select(GEOID, total_dmg) %>% 
  clean_names() %>% 
  filter(str_detect(geoid, "^36")) %>% 
  mutate(geoid = substr(geoid, 1, 11)) %>% 
  group_by(geoid) %>% 
  mutate(total_dmg = sum(total_dmg)) %>% 
  unique()

# Sandy high water mark (hwm)
Sandy_hwm_p <- read_csv("data/FilteredHWMs.csv") %>% 
  clean_names() %>% 
  select(latitude, longitude, state_name, elev_ft) %>% 
  filter(state_name == "NY") %>% 
  select(-state_name) %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) 

sf_use_s2(FALSE)
Sandy_hwm_ct <- st_join(geo2010, Sandy_hwm_p, join = st_contains) %>% 
  filter(!is.na(elev_ft))

## question: one census tract had several hwm elevation feet?
## Sandy_hwm_ct %>% group_by(geoid) %>% summarise(n=sum(n())) %>% filter(n>1)

Sandy_dmg_hwm <- inner_join(Sandy_hwm_ct, Sandy_damage)

```

```{r loan and clean 2012 census data}

# Load demographic data
credential <- Sys.getenv("census_api_key")

lookup_var <- load_variables(2012, "acs5")

demogdata2012 <- get_acs(
  geography = "tract",
  year = 2012,
  variables = c(
    white = "B02001_002", #race
    black = "B02001_003",
    indian_alaska = "B02001_004",
    asian = "B02001_005",
    pacific = "B02001_006",
    hhincome = "B19013_001", # median household income
    poverty = "C17002_001", # poverty level
    no_schooling = "B15003_002", #education attainment
    elementary_school = "B15003_009",
    middle_school = "B15003_012",
    high_school = "B15003_017",
    bachelor = "B15003_022",
    employed = "B23025_004", # employment status
    unemployed = "B23025_005",
    no_in_labor_force = "23025_007"
  ),
  state =  36,
  key = credential
)

# Tidy demogdata and change it into sf object
demogdata2012_clean <- demogdata2012 %>%
  select(-moe, -NAME) %>%
  rename(geoid = GEOID) %>% 
  pivot_wider(
    names_from = variable,
    values_from = estimate
  )

demogdata2012_sf <- left_join(
  x = demogdata2012_clean, 
  y = geo2010
) %>%
  st_as_sf() %>%
  st_transform(crs = 4326)

Sandy_modeling_data <- st_join(Sandy_dmg_hwm, demogdata2012_sf, join = st_equals) %>% 
  select(-county.y, -tract.y, -geoid.y) %>% 
  rename(county = county.x, tract = tract.x, geoid = geoid.x)

```

```{r set up modeling for Sandy }

Sandy_split <- initial_split(Sandy_modeling_data, prop = 0.75)

Sandy_train <- training(Sandy_split)
Sandy_test <- testing(Sandy_split)

Sandy_folds <- vfold_cv(Sandy_train, v = 10, repeats = 1)

#EDA
P1 <- Sandy_train %>% 
  ggplot() +
  geom_sf(aes(fill = total_dmg), color = "white") +
  scale_fill_gradient(
    low = "yellow",
    high = "red"
  )

P2 <- Sandy_train %>% 
  ggplot() +
  geom_sf(aes(fill = elev_ft), color = "white") +
  scale_fill_gradient(
    low = "yellow",
    high = "red"
  )

P1 / P2
# The elevation of water explains part of the total damage caused by Sandy hurricane.

Sandy_EDA <- function(demo_var){
 P <- Sandy_train %>% 
  mutate(
    elevation = case_when(
      elev_ft < 6.6 ~ "Min-Q1",
      elev_ft < 8.95 ~ "Q1-Median",
      elev_ft < 10.775 ~ "Median-Q3",
      TRUE ~ "Q3-Max"
    ) 
  ) %>%
  rename("estimate" = demo_var) %>% 
  ggplot() +
  geom_point(
    aes(estimate, total_dmg, color = elevation, shape = elevation),
    size = 3,
    alpha =0.7
  ) +
   labs(
     x = demo_var,
     y = "total claim of damage"
   )
  
 assign(paste("P", demo_var, sep = "_"), P,  envir = .GlobalEnv)
}

wrap_plots(
  map(.x = c("white", "bachelor", "hhincome", "employed"), .f = Sandy_EDA)
)

```